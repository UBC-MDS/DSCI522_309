---
title: "Predicting Online Sales from Webpage Analytics"
author: 
- Lesley Miller
- Cheng Min
- Shivam Verma
date: "24/01/2020"
output: 
  html_document:
    toc: true
---

```{r setup, include = FALSE, warning = FALSE, message = FALSE, echo=FALSE}
library(here)
library(tidyverse, quietly = TRUE)
library(knitr)
suppressPackageStartupMessages(library(rlang))
suppressPackageStartupMessages(library(gridExtra))
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r load data, message = FALSE, include=FALSE}
cat_vars_expo <- readRDS("results/cat_vars_expo.rds")
quantile_dist <- read_csv("results/quantile_dist.csv")
feature_importance_df <- read_csv("results/Feature_Imp.csv")
X_train <- read_csv("results/Training_pred.csv")
hyperpara <- read_csv("results/GridSearchCV.csv")
```


# Project Summary

Here we attempt to build a classification model using the light gradient boosting algorithm which can use webpage metrics from a given online shopping website to predict whether the revenue of a new customer is True (i.e., the customer purchased something) or False (i.e., the customer did not purchase anything). Our final classifier performed well on an unseen test data set, with the f1 score of `r` and the test accuray calculated to be `r`. The precision and recall of our classifier on the test set are `r` and `r` respectively. On the `r` test data cases, it correctly predicted `r`. However it incorrectly predicted `r` cases. (and these cases were FN?: predicting that a customer to purchase something when in fact no purchasing occurs). Due to the high percentage of incorrect prediction in FN, we recommend further study to improve this model.

# Introduction 
Online shopping has quckly become a dominant player in commerce. It's [been reported](https://optinmonster.com/online-shopping-statistics/) that within the next 3 years, 91% of those in the United States will have shopped online! That is nearly 300 million people for the US alone. Additionally, in 2020 the [prediction](https://optinmonster.com/online-shopping-statistics/) is that 4 trillion dollars will be spent by online shoppers. Given this enormous potential, online retailers want to know reliable ways to predict user behavior and uncover insight into what factors are most predictive of sales. The following analysis builds a binary classifier to be able to predict a sale coded as `TRUE` or no sale coded as `FALSE`. 


# Methods 
## Data Source

The data set used in this project is of online shopping webpage metrics created by C. Okan Sakar, S. Olcay Polat, Mete Katircioglu & Yomi Kastro [@]. It was sourced from the UCI Machine Learning Repository [@] and can be found [here](https://archive.ics.uci.edu/ml/datasets/Online+Shoppers+Purchasing+Intention+Dataset). Each row in the data set represents webpage metrics on a single shopper which was extracted from the URL information and includes the final action (purchase or not) and several other measurements (e.g., Number of Distinct Product Related pages, Time spent on Product Related pages, closeness of site visitng time to a special day, etc.). 

## Exploratory Data Analysis
Each row in the dataset represents a session by a single user with a total of 12,330 shopping sessions. Each unique user is represented only once in the entire dataset and is form a 1-year period. A total of 15% of the sessions end in a purchase. The table below describes each of the 18 measurements made on each online shopper. 


### Description of the webpage metrics, [data source here](https://archive.ics.uci.edu/ml/datasets/Online+Shoppers+Purchasing+Intention+Dataset)

| No. | Variable | Description |
| ----------- | ----------- | ----------- |
| 1 | `Administrative` | Number of Distinct administrative pages |
| 2 | `Informational` | Number of Distinct Informational pages |
| 3 | `ProductRelated` | Number of Distinct Product Related pages |
| 4 | `Administrative_Duration` | Time(in seconds) spent on Administrative pages |
| 5 | `Informational_Duration` | Time(in seconds) spent on Informational pages |
| 6 | `ProductRelated_Duration` | Time(in seconds) spent on Product Related pages |
| 7 | `BounceRates` | Average bounce rate of all web-pages visited by user. For a web-page its the percentage of people who visit the website from that webpage and left without raising any other request |
| 8 | `ExitRates` | Average exit rate of all web-pages visited by user: For a web-page its the percentage of people who exited the website from that webpage |
| 9 | `PageValues` | Average page value of all web-pages visited by user: For a web-page its the average dollar-value of that page which the user visited before completing the transaction |
| 10 | `SpecialDay` | The closeness of site visitng time to a special day (higher chances of a session resulting in a transaction) |
| 11 | `OperatingSystems` | Operating system used by the user |
| 12 | `Month` | Month of Year |
| 13 | `Browser` | Browser used by the user |
| 14 | `Region` | Geographic region |
| 15 | `TrafficType` | Type of Channel user by the user to arrive at the website |
| 16 | `VisitorType` | Type of the visitor |
| 17 | `Weekend` | Weekend indicator |
| 18 | `Revenue` | Revenue transaction indicator |


```{r categorical variable summary tables, include=FALSE}
### make Summary tables of categorical variables 
# convert tables into tibbles 

df <- as.data.frame(cat_vars_expo$SpecialDay)
tb1 <- as_tibble(df)
colnames(tb1) <- c("Special Day", "Percentage of Shopping Sessions")

df2 <- as.data.frame(cat_vars_expo$Month)
tb2 <- as_tibble(df2)
colnames(tb2) <- c("Month", "Percentage of Shopping Sessions")

df3 <- as.data.frame(cat_vars_expo$OperatingSystems)
tb3 <- as_tibble(df2)
colnames(tb3) <- c("Operating Systems", "Percentage of Shopping Sessions")

df4 <- as.data.frame(cat_vars_expo$Browser)
tb4 <- as_tibble(df4)
colnames(tb4) <- c("Browser", "Percentage of Shopping Sessions")

df5 <- as.data.frame(cat_vars_expo$Region)
tb5 <- as_tibble(df5)
colnames(tb5) <- c("Region", "Percentage of Shopping Sessions")

df6 <- as.data.frame(cat_vars_expo$TrafficType)
tb6 <- as_tibble(df6)
colnames(tb6) <- c("Traffict Type", "Percentage of Shopping Sessions")

df7 <- as.data.frame(cat_vars_expo$VisitorType)
tb7 <- as_tibble(df7)
colnames(tb7) <- c("Visitor Type", "Percentage of Shopping Sessions")

df8 <- as.data.frame(cat_vars_expo$Weekend)
tb8 <- as_tibble(df8)
colnames(tb8) <- c("Weekend", "Percentage of Shopping Sessions")

df9 <- as.data.frame(cat_vars_expo$Revenue)
tb9 <- as_tibble(df9)
colnames(tb9) <- c("Revenue", "Percentage of Shopping Sessions")


### plot the categorical tables 

kableExtra::kable_styling(kable(tb1,
      caption = "Distribution of Special Day"), full_width = F)

kableExtra::kable_styling(kable(tb2,
      caption = "Distribution of Month"), full_width = F)

kableExtra::kable_styling(kable(tb3,
      caption = "Distribution of Operating Systems"), full_width = F)

kableExtra::kable_styling(kable(tb4,
      caption = "Distribution of Browser"), full_width = F)

kableExtra::kable_styling(kable(tb5,
      caption = "Distribution of Region"), full_width = F)

kableExtra::kable_styling(kable(tb6,
      caption = "Distribution of Traffic Type"), full_width = F)

kableExtra::kable_styling(kable(tb7,
      caption = "Distribution of Visitor Type"), full_width = F)

kableExtra::kable_styling(kable(tb8,
      caption = "Distribution of Weekend"), full_width = F)

kableExtra::kable_styling(kable(tb9,
      caption = "Distribution of Weekend and Revenue"), full_width = F)
```

THe table below displays the cumulative distribution of all 7 continuous variables. 

```{r numeric variable summary table}

kableExtra::kable_styling(kable(quantile_dist,
      caption = "Cumulative Distribution of Numberic Variables"))
```

The multi-panel plot below details the distributions of the 8 categorical variables. It highlights how several variables are quite skewed, since a in a  given category, its values tend to be clustered around only a few values. For example, there is clearly one browser that dominates all the others regardless if there is a sale or not. The months of March, May and November constitute a substantial share of the dataset. Also with different operating systems, 4 are the most frequently used while the other 4 are barely represented. 
![](../results/img/cat_vars_dist_plot.png)

![](../results/img/num_vars_dist_plot.png)

We ran correlation analysis to see how the predictor variables are correlated with each other as well as see how the predictors are related linearly to the outcome, `Revenue`.  The heathmap below visualizes the correlation. The most positively correlated are orange to dark red while the negatively correlated variables are in progressively dark blue. Several variables are either not correlated or only weakly correlated. But others ariables, like the page type `Administrative` is strongly correlated with the the time spent on the `Administrative` page coded as `Administrative_Duration`. This is also true of the other page types, `Informational` and `Product Related`. These too, are highly correlated with the time spent on them which intuitively makes sense. `PageValues` which is the average dollar value of the page, is the most positively correlated with `Revenue`; while `Exit Rates` and `Bounce Rates` have slight negative correlation with `Revenue`. 

![](../results/img/corr_plot.png)



## Modelling 

```{r feature importance}

feature_importance_df %>% 
      filter(Feature_Imp > 40) %>% 
      ggplot(aes(x = reorder(col_names, -Feature_Imp), y = Feature_Imp)) + 
      geom_col() +
      labs(title = "Top 10 Most Important Features for Predicting Sales",
           x = "Features",
           y = "Weight of Importance") + 
      coord_flip() 
      
      
```

# Results and Discussion 
## Results

## Limitations 

## Future Directions 


# References 